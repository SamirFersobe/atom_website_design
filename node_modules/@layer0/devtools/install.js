/**
 * Adds Devtools script and style tags to the page <head> section
 *
 * IMPORTANT:
 * For now this module is not transpiled by tsc or babel
 * so it must be a valid nodeJS/browser file.
 *
 */
const LAYER0_DEVTOOLS_ASSETS_PATH = '/__layer0__/devtools/'
const LAYER0_DEVTOOLS_MAIN_JS = LAYER0_DEVTOOLS_ASSETS_PATH + 'main.js'
const LAYER0_DEVTOOLS_MAIN_CSS = LAYER0_DEVTOOLS_ASSETS_PATH + 'main.css'

const LAYER0_DEVTOOLS_COOKIE = 'layer0_devtools_enabled'
const LAYER0_DEVTOOLS_ENV_COOKIE = 'layer0_devtools_env_enabled'

function getCookieValue(cookieName) {
  const cookieContent = document.cookie
  if (cookieContent.indexOf(cookieName + '=') === -1) {
    return null
  }
  return cookieContent.indexOf(cookieName + '=true') >= 0
}

/**
 * Check if the Devtools is enabled, by order of priority
 * - per user own cookie set via GET /__layer0__/devtools/{enable,disable}
 * - per environment constibale config enable/disable
 * - enabled by default for moovweb and localhost hostnames
 * - disabled
 */
function isEnabled() {
  const userCookieValue = getCookieValue(LAYER0_DEVTOOLS_COOKIE)

  if (userCookieValue !== null) {
    return userCookieValue
  }

  const envCookieValue = getCookieValue(LAYER0_DEVTOOLS_ENV_COOKIE)

  if (envCookieValue !== null) {
    return envCookieValue
  }

  if (
    /127\.0\.0\.1|^localhost(:\d+)?$|moovweb-edge(-dev)?\.io$|layer0(-dev|-limelight|-limelight-dev)?(-perma)?\.link$/.test(
      window.location.host
    )
  ) {
    return true
  }

  return false
}

module.exports = function install() {
  if (typeof window === 'undefined') {
    // This should not execute on SSR
    return
  }

  if (!isEnabled()) {
    return
  }

  if (document.head.querySelectorAll('script[src="' + LAYER0_DEVTOOLS_MAIN_JS + '"]').length) {
    // Devtools is already mounted
    return
  }

  const script = document.createElement('script')
  const link = document.createElement('link')

  script.defer = true
  script.src = LAYER0_DEVTOOLS_MAIN_JS

  link.rel = 'stylesheet'
  link.href = LAYER0_DEVTOOLS_MAIN_CSS

  document.head.appendChild(script)
  document.head.appendChild(link)
}
