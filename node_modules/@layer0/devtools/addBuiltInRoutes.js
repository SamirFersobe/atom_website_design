const path = require('path')

const FAR_FUTURE_TTL = 60 * 60 * 24 * 365 * 10

const PUBLIC_CACHE_CONFIG = {
  edge: {
    maxAgeSeconds: FAR_FUTURE_TTL,
  },
  browser: false,
}

const LAYER0_DEVTOOLS_ENABLED_COOKIE = 'layer0_devtools_enabled'
const LAYER0_DEVTOOLS_ENV_ENABLED_COOKIE = 'layer0_devtools_env_enabled'

function isDevtoolEnabledByDefault() {
  if (process.env.LAYER0_DEVTOOLS_ENABLED) {
    return process.env.LAYER0_DEVTOOLS_ENABLED === 'true'
  }
  // LAYER0_DEVTOOLS_ENABLED cannot be set manually on Environment config
  // because LAYER0_* is reserved for internal usage, which we will use when adding
  // that feature explictely to LD interface.
  // Meanwhile, the PREVIEW_LAYER0_DEVTOOLS_ENABLED can be set manually by anyone
  if (process.env.PREVIEW_LAYER0_DEVTOOLS_ENABLED) {
    return process.env.PREVIEW_LAYER0_DEVTOOLS_ENABLED === 'true'
  }

  // If neither of those are defined, we fallback on default behavior:
  // it will be enabled on local and moovweb-edge(-dev).io domains
  return null
}

module.exports = function addBuiltInRoutes({ router, local }) {
  if (isDevtoolEnabledByDefault() !== null) {
    router.match('/(.*)', ({ addResponseCookie }) => {
      addResponseCookie(
        LAYER0_DEVTOOLS_ENV_ENABLED_COOKIE,
        `${isDevtoolEnabledByDefault()}; Path=/`
      )
    })
  }
  if (local) {
    router
      .get('/__layer0__/caching', writer => {
        writer.send(JSON.stringify({ local, enabled: process.env.LAYER0_CACHE === 'true' }))
      })
      .post('/__layer0__/caching', writer => {
        const q = writer.request.query
        if (q) {
          process.env.LAYER0_CACHE = q.enabled
        }
        writer.send('done')
      })
  }
  router
    .get('/__layer0__/devtools/enable', ({ redirect, addResponseCookie }) => {
      addResponseCookie(LAYER0_DEVTOOLS_ENABLED_COOKIE, 'true; Path=/')
      redirect('/')
    })
    .get('/__layer0__/devtools/disable', ({ redirect, addResponseCookie }) => {
      addResponseCookie(LAYER0_DEVTOOLS_ENABLED_COOKIE, 'false; Path=/')
      redirect('/')
    })
    .match('/__layer0__/devtools/:path*', ({ cache, serveStatic }) => {
      cache(PUBLIC_CACHE_CONFIG)
      serveStatic(path.join('node_modules', '@layer0', 'devtools', 'widget', ':path*'))
    })
}
