"use strict";

const {
  join
} = require('path');

const serveFunction = require('../serverless/serveFunction');

const slash = require('slash');

const chalk = require('chalk');

const serveStaticAssets = require('../serverless/serveStaticAssets');
/**
 * Runs the bundled app, simulating the serverless environment
 * @param dir The .layer0 directory
 */


module.exports = async function runWithServerless(dir) {
  const jsDir = join(dir, 'lambda');
  const assetsDir = join(dir, 's3');
  const permanentAssetsDir = join(dir, 's3-permanent');
  const jsPort = parseInt(process.env.PORT || 3000);
  const staticPort = jsPort + 2;
  process.chdir(jsDir); // needed for environment.isCloud() to return true

  process.env.LAYER0_DEPLOYMENT_TYPE = 'AWS';
  process.env.NODE_ENV = 'production';
  process.env.LAYER0_CACHE = 'true';
  process.env.LAYER0_LOCAL = 'true'; // this turns off the wrapping of stdout, stderr

  process.env.LAYER0_IMAGE_OPTIMIZER_HOST = '127.0.0.1';
  process.env.LAYER0_IMAGE_OPTIMIZER_PORT = jsPort; // needed for ResponseWriter.serveStatic to know how to contact the static asset server

  process.env.LAYER0_CONFIG = JSON.stringify({
    backends: {
      __static__: {
        domainOrIp: `127.0.0.1:${staticPort}`
      },
      __permanent_static__: {
        domainOrIp: `127.0.0.1:${staticPort}`
      }
    }
  }); // lambda server

  const handler = require(slash(jsDir) + '/handler.js').handler;

  serveFunction(handler, jsPort);
  serveStaticAssets([assetsDir, permanentAssetsDir], staticPort);
  console.log(chalk.green(`> Application ready on http://localhost:${jsPort}`));
};